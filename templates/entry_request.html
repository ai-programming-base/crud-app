{% extends "_base.html" %}

{% block title %}入庫申請{% endblock %}

{% block head %}
<style>
    table { border-collapse: collapse; }
    th, td { border: 1px solid #aaa; padding: 5px 10px; }
    th { background: #eee; }
    .button-group { margin-top: 18px; }
    .main-btn {
        background: #4285f4;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: bold;
        padding: 6px 16px;
        margin-right: 8px;
        cursor: pointer;
        text-decoration: none;
        transition: background .15s;
    }
    .main-btn:hover { background: #23468e; color: #fff; }
    .form-field { margin-bottom: 12px; }
    .form-label { display: block; font-weight: bold; margin-bottom: 4px; }
    .form-input, .form-textarea, .form-select { width: 320px; font-size: 1rem; padding: 5px; border-radius: 4px; border: 1px solid #bbb; }
    .form-input[type="date"] {
        width: 140px;
        min-width: 100px;
        max-width: 180px;
    }
    .form-textarea { height: 56px; resize: vertical; }
    .info-message { color: #33691e; font-weight: bold; margin: 8px 0; }
    .suggest-list { 
        position: absolute; background: #fff; border: 1px solid #bbb; border-radius: 6px;
        box-shadow: 0 2px 8px #bbb8; z-index: 100; min-width: 320px; max-height: 180px; overflow-y: auto;
        display: none;
    }
    .suggest-item {
        padding: 6px 16px; cursor: pointer;
    }
    .suggest-item:hover, .suggest-item.active {
        background: #e3f2fd;
    }
    .relative { position: relative; }
    .input-clear-wrap {
        position: relative;
        display: inline-block;
        width: 320px;
        vertical-align: middle;
    }
    .form-input {
        width: 100%;
        box-sizing: border-box;
    }
    .clear-btn {
        position: absolute;
        right: 6px;
        top: 55%;  /* ← 50%から55%に変更 */
        transform: translateY(-40%); /* ← これで真ん中より少し下 */
        cursor: pointer;
        font-size: 1.03em;
        color: #bbb;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        line-height: 1;
        display: none;
        z-index: 10;
        width: 1.3em;
        height: 1.3em;
        text-align: center;
        transition: color 0.13s;
        user-select: none;
    }
    .clear-btn:hover {
        color: #888;
        background: none;
    }
    /* 所有者セルのレイアウト */
    .owner-cell .input-clear-wrap { width: 280px; }
    .owner-cell .form-input { padding-right: 1.8em; } /* ×ボタンの余白 */
    .owner-cell .clear-btn { top: 50%; transform: translateY(-50%); }
    /* 所有者サジェスト */
    .owner-suggest.suggest-list { min-width: 280px; }
    .owner-visible.invalid {
        border-color: #e53935;
        background: #ffebee;
    }
</style>
{% endblock %}

{% block content %}
<h1>入庫申請</h1>
{% if message %}
  <div class="info-message">{{ message }}</div>
{% endif %}
{% if not finish %}
<form method="get" onsubmit="return checkAndSubmit();">
    {% if request.args.get('from_menu') %}
        <input type="hidden" name="from_menu" value="1">
    {% endif %}
    <input type="hidden" name="action" value="submit">
    <table>
        <tr>
            <th>ID</th>
            {% for f in fields %}
            <th>{{ f.name }}</th>
            {% endfor %}
            <th>サンプル数</th>
            <th>数量チェック</th>
        </tr>
        {% for item in items %}
        <tr>
            <td>
                {{ item['id'] }}
                <input type="hidden" name="item_id" value="{{ item['id'] }}">
            </td>
            {% for f in fields %}
            <td>{{ item[f.key] }}</td>
            {% endfor %}
            <td>{{ item['num_of_samples'] }}</td>
            <td><input type="checkbox" name="qty_checked"></td>
        </tr>
        {% endfor %}
    </table>
    <div style="margin-top: 24px; margin-bottom: 8px;">
        <!-- 管理者欄（サジェスト化＋クリアボタン付） -->
        <div class="form-field relative">
            <label class="form-label" for="manager_input">管理者</label>
            <div class="input-clear-wrap">
                <input class="form-input" type="text" id="manager_input" autocomplete="off" value="" placeholder="管理者を入力">
                <span id="manager_clear" class="clear-btn" title="クリア">&#10005;</span>
            </div>
            <input type="hidden" id="manager" name="manager" value="">
            <div id="manager_suggest" class="suggest-list"></div>
        </div>
        <!-- チェックボックス -->
        <div class="form-field">
            <label class="form-label">
                <input type="checkbox" name="with_checkout" value="1" id="with_checkout_cb"> 持ち出し申請を同時に行う
            </label>
        </div>
        <!-- 持ち出し申請欄：トグル表示 -->
        <div id="checkout-area" style="display:none;">
            <div class="form-field">
                <label class="form-label" for="start_date">持ち出し開始日</label>
                <input class="form-input" type="date" id="start_date" name="start_date">
            </div>
            <div class="form-field">
                <label class="form-label" for="end_date">持ち出し終了日</label>
                <input class="form-input" type="date" id="end_date" name="end_date">
            </div>
            <div id="owner-tables-area" style="margin-top:25px;"></div>
        </div>
        <div id="with_transfer_area" style="display:none; margin-top:8px;">
            <label class="form-label">
                <input type="checkbox" name="with_transfer" value="1" id="with_transfer_cb">
                譲渡申請も同時に行う
            </label>
            <div id="transfer-detail-area" style="display:none; margin-top:8px;">
                <div class="form-field">
                    <label class="form-label" for="transfer_date">譲渡日</label>
                    <input class="form-input" type="date" id="transfer_date" name="transfer_date">
                </div>
                <div id="transfer-branch-tables"></div>
                <div class="form-field">
                    <label class="form-label" for="transfer_comment">譲渡コメント</label>
                    <textarea class="form-textarea" id="transfer_comment" name="transfer_comment"></textarea>
                </div>
            </div>
        </div>
        <!-- 申請コメント -->
        <div class="form-field">
            <label class="form-label" for="comment">申請コメント</label>
            <textarea class="form-textarea" id="comment" name="comment"></textarea>
        </div>
        <!-- 承認者：ドロップダウン -->
        <div class="form-field">
            <label class="form-label" for="approver">承認者</label>
            <select class="form-select" id="approver" name="approver" required>
                {% for m in approver_list %}
                    <option value="{{ m.username }}"
                        {% if m.username == approver_default %}selected{% endif %}>
                        {{ m.department }} {{ m.realname }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="button-group">
        <button type="submit" class="main-btn">申請</button>
        <a href="{% if request.args.get('from_menu') or request.form.get('from_menu') %}{{ url_for('menu') }}{% else %}{{ url_for('index') }}{% endif %}" class="main-btn" style="background:#aaa;">キャンセル</a>
    </div>
</form>
{% endif %}
{% if finish %}
<h2>申請内容</h2>
<table>
    <tr>
        <th>ID</th>
        {% for f in fields %}
        <th>{{ f.name }}</th>
        {% endfor %}
    </tr>
    {% for item in items %}
    <tr>
        <td>{{ item['id'] }}</td>
        {% for f in fields %}
        <td>{{ item[f.key] }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>
<div class="button-group" style="margin-top: 20px;">
    <a href="{{ url_for('index') }}" class="main-btn" style="background:#4285f4;">一覧に戻る</a>
</div>
{% endif %}
<script>
    {% if error_dialog_message %}
        alert({{ error_dialog_message|tojson }});
    {% endif %}

    // --- データ供給 ---
    const properUsers = {{ proper_users|tojson|safe }};   // 既存（管理者サジェスト用）
    const ownerCandidates = {{ owner_candidates|tojson|safe }}; // ▼ 追加（所有者サジェスト用）
    const myUsername = "{{ manager_default|e }}";
    const myUserForManager = properUsers.find(u => u.username === myUsername);
    // 所有者欄の初期値はログインユーザー（proper/partner問わず）を候補から検索
    const myUserForOwner = ownerCandidates.find(u => u.username === "{{ g.user['username'] }}");

    function formatUser(user) {
        return (user.department ? user.department : "") + " " + user.realname;
    }

    // ▼ 共通：サジェストの描画（与えられたcontainerに出す）
    function renderSuggestList(container, users, onPick) {
        container.innerHTML = "";
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = "suggest-item";
            div.textContent = formatUser(user);
            div.dataset.username = user.username;
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                onPick(user);
            });
            container.appendChild(div);
        });
        container.style.display = users.length > 0 ? "block" : "none";
    }

    // ▼ 所有者入力ウィジェットの紐付け
    function wireOwnerInput(ids) {
        const {inputEl, hiddenEl, clearEl, suggestEl} = ids;

        function pickUser(user) {
            inputEl.value = formatUser(user);
            hiddenEl.value = user.username;
            suggestEl.style.display = "none";
            clearEl.style.display = "inline";
            inputEl.classList.remove('invalid');
        }

        function openFullList() {
            renderSuggestList(suggestEl, ownerCandidates, pickUser);
        }

        function filterAndShow() {
            const val = inputEl.value.trim();
            if (val.length === 0) {
                hiddenEl.value = "";
                suggestEl.style.display = "none";
                clearEl.style.display = "none";
                return;
            }
            // 部分一致（部署名 or 氏名）
            const filtered = ownerCandidates.filter(u =>
                (u.department && u.department.indexOf(val) !== -1) ||
                (u.realname && u.realname.indexOf(val) !== -1)
            );
            renderSuggestList(suggestEl, filtered, pickUser);
            hiddenEl.value = ""; // 未確定
            clearEl.style.display = "inline";
        }

        function tryResolveExact() {
            const txt = inputEl.value.trim();
            // 完全一致（"部署 氏名"）
            const exact = ownerCandidates.find(u => formatUser(u) === txt);
            hiddenEl.value = exact ? exact.username : "";
        }

        inputEl.addEventListener('focus', openFullList);
        inputEl.addEventListener('input', filterAndShow);
        inputEl.addEventListener('blur', () => {
            setTimeout(() => { suggestEl.style.display = "none"; }, 150);
            const txt = (inputEl.value || "").trim();
            // テキストがあるのに hidden が未確定 → 不正
            if (txt.length > 0 && !hiddenEl.value) {
                inputEl.classList.add('invalid');
            } else {
                inputEl.classList.remove('invalid');
            }
        });
        inputEl.addEventListener('paste', () => {
            // ペースト内容の確定は input イベントに乗るのでここでは何もしない
            setTimeout(tryResolveExact, 0);
        });
        inputEl.addEventListener('change', tryResolveExact);

        clearEl.addEventListener('click', (e) => {
            e.preventDefault();
            inputEl.value = "";
            hiddenEl.value = "";
            clearEl.style.display = "none";
            suggestEl.style.display = "none";
        });
    }

    // --- 管理者欄（既存ロジック） ---
    function showSuggestList(users) {
        const suggest = document.getElementById('manager_suggest');
        suggest.innerHTML = "";
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = "suggest-item";
            div.textContent = formatUser(user);
            div.dataset.username = user.username;
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.getElementById('manager_input').value = formatUser(user);
                document.getElementById('manager').value = user.username;
                suggest.style.display = "none";
                document.getElementById('manager_clear').style.display = "inline";
            });
            suggest.appendChild(div);
        });
        suggest.style.display = users.length > 0 ? "block" : "none";
    }

    document.addEventListener("DOMContentLoaded", function() {
        // --- 管理者欄 初期化（既存維持） ---
        const input = document.getElementById('manager_input');
        const hidden = document.getElementById('manager');
        const suggest = document.getElementById('manager_suggest');
        const clearBtn = document.getElementById('manager_clear');

        if (myUserForManager) {
            input.value = formatUser(myUserForManager);
            hidden.value = myUserForManager.username;
            clearBtn.style.display = "inline";
        } else {
            input.value = "";
            hidden.value = "";
            clearBtn.style.display = "none";
        }
        input.addEventListener('focus', function(){ showSuggestList(properUsers); });
        input.addEventListener('input', function(){
            const val = input.value;
            if (val.length === 0) {
                input.value = "";
                hidden.value = "";
                suggest.style.display = "none";
                clearBtn.style.display = "none";
                return;
            }
            const filtered = properUsers.filter(
                u => (u.realname && u.realname.indexOf(val) !== -1) || (u.department && u.department.indexOf(val) !== -1)
            );
            showSuggestList(filtered);
            hidden.value = "";
            clearBtn.style.display = "inline";
        });
        input.addEventListener('focus', function(){ if (input.value.length > 0) clearBtn.style.display="inline"; });
        input.addEventListener('blur', function(){ setTimeout(function(){ suggest.style.display="none"; }, 150); });
        clearBtn.addEventListener('click', function(e){
            e.preventDefault();
            input.value = "";
            hidden.value = "";
            clearBtn.style.display = "none";
            suggest.style.display = "none";
        });
        document.addEventListener('mousedown', function(e){
            if (!input.contains(e.target) && !suggest.contains(e.target) && e.target !== clearBtn) {
                suggest.style.display = "none";
            }
        });

        document.getElementById('start_date').value = getToday();
        document.getElementById('end_date').value = getThreeMonthLast();
        document.getElementById('transfer_date').value = getToday();

        const cb_checkout = document.getElementById('with_checkout_cb');
        const area_checkout = document.getElementById('checkout-area');
        const area_transfer = document.getElementById('with_transfer_area');
        const cb_transfer = document.getElementById('with_transfer_cb');
        const transferDetailArea = document.getElementById('transfer-detail-area');
        const ownerTablesArea = document.getElementById('owner-tables-area');

        function toggleCheckoutArea() {
            area_checkout.style.display = cb_checkout.checked ? "block" : "none";
            area_transfer.style.display = cb_checkout.checked ? "block" : "none";
            if (cb_checkout.checked) {
                if (typeof createOwnerTables === 'function') createOwnerTables();
            } else {
                ownerTablesArea.innerHTML = '';
            }
            if (!cb_checkout.checked) {
                cb_transfer.checked = false;
                transferDetailArea.style.display = "none";
            }
        }
        function toggleTransferDetail() {
            transferDetailArea.style.display = cb_transfer.checked ? "block" : "none";
            if (cb_transfer.checked) {
                createTransferBranchTables();
            } else {
                document.getElementById('transfer-branch-tables').innerHTML = '';
            }
        }

        cb_checkout.addEventListener('change', toggleCheckoutArea);
        cb_transfer.addEventListener('change', toggleTransferDetail);
        toggleCheckoutArea();
        toggleTransferDetail();
    });

    function getToday() {
        const d = new Date();
        return d.toISOString().slice(0, 10);
    }
    function getThreeMonthLast() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const after3 = new Date(y, m + 3, 1);
        const lastDay = new Date(after3.getFullYear(), after3.getMonth(), 0);
        return lastDay.toLocaleDateString('ja-JP', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\//g, '-');
    }

    function checkAndSubmit() {
        var checks = document.querySelectorAll('input[name="qty_checked"]:not(:checked)');
        if (checks.length > 0) {
            alert("全ての数量チェックにチェックしてください");
            return false;
        }
        var manager = document.getElementById('manager').value;
        if (!manager) {
            alert("管理者の入力が不正です。正しい管理者を選択してください");
            document.getElementById('manager_input').focus();
            return false;
        }
        var cb_checkout = document.getElementById('with_checkout_cb');
        if (cb_checkout.checked) {
            const ownerHiddens = document.querySelectorAll('input[name^="owner_list_"]');
            if (ownerHiddens.length === 0) {
                alert("所有者の入力欄生成に失敗しました。ページを更新してやり直してください。");
                return false;
            }
            let firstInvalid = null;
            ownerHiddens.forEach(h => {
                const cell = h.closest('.owner-cell');
                const vis = cell ? cell.querySelector('.owner-visible') : null;
                // hidden（実値）が空＝不正
                if (!h.value) {
                    if (vis) vis.classList.add('invalid');
                    if (!firstInvalid) firstInvalid = vis || h;
                }
            });
            if (firstInvalid) {
                alert("所有者の入力が不正です。候補から選択してください。");
                if (firstInvalid.focus) firstInvalid.focus();
                return false; // ← 送信を停止
            }
        }
        var cb_transfer = document.getElementById('with_transfer_cb');
        if (cb_checkout.checked && cb_transfer.checked) {
            var checkedBranches = document.querySelectorAll('input[name="transfer_branch_ids"]:checked');
            if (checkedBranches.length == 0) {
                alert("譲渡する枝番を1つ以上選択してください");
                return false;
            }
            var transferComment = document.getElementById('transfer_comment').value.trim();
            if (!transferComment) {
                alert("譲渡コメントを入力してください");
                return false;
            }
        }
        return true;
    }

    function createOwnerTables() {
        const area = document.getElementById('owner-tables-area');
        area.innerHTML = '';
        if (!document.getElementById('with_checkout_cb').checked) {
            area.style.display = "none";
            return;
        }
        area.style.display = "block";

        const items = [];
        {% for item in items %}
            items.push({
                id: "{{ item['id'] }}",
                num_of_samples: parseInt("{{ item['num_of_samples']|default(1) }}"),
                product_name: "{{ item['product_name']|default('')|e }}"
            });
        {% endfor %}

        const me = "{{ g.user['username'] }}";
        const myUser = ownerCandidates.find(u => u.username === me);

        let htmlAll = `<b>所有者</b>`;
        for (const it of items) {
            const n = (it.num_of_samples && it.num_of_samples > 0) ? it.num_of_samples : 1;
            let t = `<div style="margin-top:12px; margin-bottom:20px;"><b>ID ${it.id}（${it.product_name}）</b><br>
                <table style="border-collapse:collapse;">
                  <tr>
                    <th style="border:1px solid #aaa;padding:5px 10px;">枝番</th>
                    <th style="border:1px solid #aaa;padding:5px 10px;">所有者</th>
                  </tr>`;
            for (let i=1; i<=n; i++) {
                const inputId = `owner_input_${it.id}_${i}`;
                const hiddenId = `owner_hidden_${it.id}_${i}`;
                const clearId = `owner_clear_${it.id}_${i}`;
                const suggestId = `owner_suggest_${it.id}_${i}`;
                const defaultVisible = myUser ? formatUser(myUser) : "";
                const defaultHidden = myUser ? myUser.username : "";

                // hidden の name は従来通り owner_list_{itemId}（同名複数でサーバ側で配列化）
                t += `
                  <tr>
                    <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">${i}</td>
                    <td class="owner-cell" style="border:1px solid #aaa;padding:5px 10px;position:relative;">
                        <div class="input-clear-wrap">
                            <input type="text" class="form-input owner-visible"
                                   id="${inputId}" autocomplete="off"
                                   placeholder="部署名 氏名"
                                   value="${defaultVisible}">
                            <span id="${clearId}" class="clear-btn owner-clear" title="クリア" style="${defaultVisible ? 'display:inline' : 'display:none'}">&#10005;</span>
                        </div>
                        <input type="hidden" name="owner_list_${it.id}" id="${hiddenId}" value="${defaultHidden}">
                        <div id="${suggestId}" class="suggest-list owner-suggest"></div>
                    </td>
                  </tr>`;
            }
            t += `</table></div>`;
            htmlAll += t;
        }
        area.innerHTML = htmlAll;

        // 各セルを配線
        for (const it of items) {
            const n = (it.num_of_samples && it.num_of_samples > 0) ? it.num_of_samples : 1;
            for (let i=1; i<=n; i++) {
                wireOwnerInput({
                    inputEl: document.getElementById(`owner_input_${it.id}_${i}`),
                    hiddenEl: document.getElementById(`owner_hidden_${it.id}_${i}`),
                    clearEl: document.getElementById(`owner_clear_${it.id}_${i}`),
                    suggestEl: document.getElementById(`owner_suggest_${it.id}_${i}`),
                });
            }
        }
    }
    function createTransferBranchTables() {
        let area = document.getElementById('transfer-branch-tables');
        area.innerHTML = '';
        let items = [];
        {% for item in items %}
            items.push({
                id: "{{ item['id'] }}",
                num_of_samples: parseInt("{{ item['num_of_samples']|default(1) }}"),
                product_name: "{{ item['product_name']|default('')|e }}"
            });
        {% endfor %}
        let allHtml = "";
        for (let it of items) {
            let n = it.num_of_samples; if (!n || n <= 0) n = 1;
            let t = `<div style="margin-bottom:18px;"><b>ID ${it.id}（${it.product_name}） 譲渡する枝番を選択</b>
                <table style="border-collapse:collapse;">
                <tr>
                    <th style="border:1px solid #aaa;padding:5px 10px;">選択</th>
                    <th style="border:1px solid #aaa;padding:5px 10px;">枝番</th>
                </tr>`;
            for (let i = 1; i <= n; i++) {
                t += `<tr>
                <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">
                    <input type="checkbox" name="transfer_branch_ids" value="${it.id}_${i}">
                </td>
                <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">${i}</td>
                </tr>`;
            }
            t += `</table></div>`;
            allHtml += t;
        }
        area.innerHTML = allHtml;
    }
</script>
{% endblock %}
