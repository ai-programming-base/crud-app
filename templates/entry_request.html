{% extends "_base.html" %}

{% block title %}入庫申請{% endblock %}

{% block head %}
<style>
    table { border-collapse: collapse; }
    th, td { border: 1px solid #aaa; padding: 5px 10px; }
    th { background: #eee; }
    .button-group { margin-top: 18px; }
    .main-btn {
        background: #4285f4;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: bold;
        padding: 6px 16px;
        margin-right: 8px;
        cursor: pointer;
        text-decoration: none;
        transition: background .15s;
    }
    .main-btn:hover { background: #23468e; color: #fff; }
    .form-field { margin-bottom: 12px; }
    .form-label { display: block; font-weight: bold; margin-bottom: 4px; }
    .form-input, .form-textarea, .form-select { width: 320px; font-size: 1rem; padding: 5px; border-radius: 4px; border: 1px solid #bbb; }
    .form-input[type="date"] {
        width: 140px;
        min-width: 100px;
        max-width: 180px;
    }
    .form-textarea { height: 56px; resize: vertical; }
    .info-message { color: #33691e; font-weight: bold; margin: 8px 0; }
    .suggest-list { 
        position: absolute; background: #fff; border: 1px solid #bbb; border-radius: 6px;
        box-shadow: 0 2px 8px #bbb8; z-index: 100; min-width: 320px; max-height: 180px; overflow-y: auto;
        display: none;
    }
    .suggest-item {
        padding: 6px 16px; cursor: pointer;
    }
    .suggest-item:hover, .suggest-item.active {
        background: #e3f2fd;
    }
    .relative { position: relative; }
    .input-clear-wrap {
        position: relative;
        display: inline-block;
        width: 320px;
        vertical-align: middle;
    }
    .form-input {
        width: 100%;
        box-sizing: border-box;
    }
    .clear-btn {
        position: absolute;
        right: 6px;
        top: 55%;  /* ← 50%から55%に変更 */
        transform: translateY(-40%); /* ← これで真ん中より少し下 */
        cursor: pointer;
        font-size: 1.03em;
        color: #bbb;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        line-height: 1;
        display: none;
        z-index: 10;
        width: 1.3em;
        height: 1.3em;
        text-align: center;
        transition: color 0.13s;
        user-select: none;
    }
    .clear-btn:hover {
        color: #888;
        background: none;
    }
</style>
{% endblock %}

{% block content %}
<h1>入庫申請</h1>
{% if message %}
  <div class="info-message">{{ message }}</div>
{% endif %}
{% if not finish %}
<form method="get" onsubmit="return checkAndSubmit();">
    {% if request.args.get('from_menu') %}
        <input type="hidden" name="from_menu" value="1">
    {% endif %}
    <input type="hidden" name="action" value="submit">
    <table>
        <tr>
            <th>ID</th>
            {% for f in fields %}
            <th>{{ f.name }}</th>
            {% endfor %}
            <th>サンプル数</th>
            <th>数量チェック</th>
        </tr>
        {% for item in items %}
        <tr>
            <td>
                {{ item['id'] }}
                <input type="hidden" name="item_id" value="{{ item['id'] }}">
            </td>
            {% for f in fields %}
            <td>{{ item[f.key] }}</td>
            {% endfor %}
            <td>{{ item['num_of_samples'] }}</td>
            <td><input type="checkbox" name="qty_checked"></td>
        </tr>
        {% endfor %}
    </table>
    <div style="margin-top: 24px; margin-bottom: 8px;">
        <!-- 管理者欄（サジェスト化＋クリアボタン付） -->
        <div class="form-field relative">
            <label class="form-label" for="manager_input">管理者</label>
            <div class="input-clear-wrap">
                <input class="form-input" type="text" id="manager_input" autocomplete="off" value="" placeholder="管理者を入力">
                <span id="manager_clear" class="clear-btn" title="クリア">&#10005;</span>
            </div>
            <input type="hidden" id="manager" name="manager" value="">
            <div id="manager_suggest" class="suggest-list"></div>
        </div>
        <!-- チェックボックス -->
        <div class="form-field">
            <label class="form-label">
                <input type="checkbox" name="with_checkout" value="1" id="with_checkout_cb"> 持ち出し申請を同時に行う
            </label>
        </div>
        <!-- 持ち出し申請欄：トグル表示 -->
        <div id="checkout-area" style="display:none;">
            <div class="form-field">
                <label class="form-label" for="start_date">持ち出し開始日</label>
                <input class="form-input" type="date" id="start_date" name="start_date">
            </div>
            <div class="form-field">
                <label class="form-label" for="end_date">持ち出し終了日</label>
                <input class="form-input" type="date" id="end_date" name="end_date">
            </div>
            <div id="owner-tables-area" style="margin-top:25px;"></div>
        </div>
        <div id="with_transfer_area" style="display:none; margin-top:8px;">
            <label class="form-label">
                <input type="checkbox" name="with_transfer" value="1" id="with_transfer_cb">
                譲渡申請も同時に行う
            </label>
            <div id="transfer-detail-area" style="display:none; margin-top:8px;">
                <div class="form-field">
                    <label class="form-label" for="transfer_date">譲渡日</label>
                    <input class="form-input" type="date" id="transfer_date" name="transfer_date">
                </div>
                <div id="transfer-branch-tables"></div>
                <div class="form-field">
                    <label class="form-label" for="transfer_comment">譲渡コメント</label>
                    <textarea class="form-textarea" id="transfer_comment" name="transfer_comment"></textarea>
                </div>
            </div>
        </div>
        <!-- 申請コメント -->
        <div class="form-field">
            <label class="form-label" for="comment">申請コメント</label>
            <textarea class="form-textarea" id="comment" name="comment"></textarea>
        </div>
        <!-- 承認者：ドロップダウン -->
        <div class="form-field">
            <label class="form-label" for="approver">承認者</label>
            <select class="form-select" id="approver" name="approver" required>
                {% for m in approver_list %}
                    <option value="{{ m.username }}"
                        {% if m.username == approver_default %}selected{% endif %}>
                        {{ m.department }} {{ m.realname }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="button-group">
        <button type="submit" class="main-btn">申請</button>
        <a href="{% if request.args.get('from_menu') or request.form.get('from_menu') %}{{ url_for('menu') }}{% else %}{{ url_for('index') }}{% endif %}" class="main-btn" style="background:#aaa;">キャンセル</a>
    </div>
</form>
{% endif %}
{% if finish %}
<h2>申請内容</h2>
<table>
    <tr>
        <th>ID</th>
        {% for f in fields %}
        <th>{{ f.name }}</th>
        {% endfor %}
    </tr>
    {% for item in items %}
    <tr>
        <td>{{ item['id'] }}</td>
        {% for f in fields %}
        <td>{{ item[f.key] }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>
<div class="button-group" style="margin-top: 20px;">
    <a href="{{ url_for('index') }}" class="main-btn" style="background:#4285f4;">一覧に戻る</a>
</div>
{% endif %}
<script>
    {% if error_dialog_message %}
        alert("{{ error_dialog_message|escapejs }}");
    {% endif %}
    // properユーザーサジェスト
    const properUsers = {{ proper_users|tojson|safe }};
    const myUsername = "{{ manager_default|e }}";
    const myUser = properUsers.find(u => u.username === myUsername);

    function formatUser(user) {
        return (user.department ? user.department : "") + " " + user.realname;
    }

    function showSuggestList(users) {
        const suggest = document.getElementById('manager_suggest');
        suggest.innerHTML = "";
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = "suggest-item";
            div.textContent = formatUser(user);
            div.dataset.username = user.username;
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.getElementById('manager_input').value = formatUser(user);
                document.getElementById('manager').value = user.username;
                suggest.style.display = "none";
                document.getElementById('manager_clear').style.display = "inline";
            });
            suggest.appendChild(div);
        });
        if (users.length > 0) {
            suggest.style.display = "block";
        } else {
            suggest.style.display = "none";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        // 管理者欄サジェスト初期化
        const input = document.getElementById('manager_input');
        const hidden = document.getElementById('manager');
        const suggest = document.getElementById('manager_suggest');
        const clearBtn = document.getElementById('manager_clear');

        // デフォルト：自分
        if (myUser) {
            input.value = formatUser(myUser);
            hidden.value = myUser.username;
            clearBtn.style.display = "inline";
        } else {
            input.value = "";
            hidden.value = "";
            clearBtn.style.display = "none";
        }

        input.addEventListener('focus', function() {
            // 候補リスト表示
            showSuggestList(properUsers);
        });
        input.addEventListener('input', function(e) {
            const val = input.value;
            if (val.length === 0) {
                input.value = "";
                hidden.value = "";
                suggest.style.display = "none";
                clearBtn.style.display = "none";
                return;
            }
            // 入力が1文字以上: realnameで部分一致
            const filtered = properUsers.filter(
                u => u.realname.indexOf(val) !== -1
            );
            showSuggestList(filtered);
            hidden.value = "";
            clearBtn.style.display = "inline";
        });

        // クリアボタン表示制御
        input.addEventListener('focus', function() {
            if (input.value.length > 0) {
                clearBtn.style.display = "inline";
            }
        });
        input.addEventListener('blur', function() {
            setTimeout(function() {
                suggest.style.display = "none";
            }, 150); // サジェスト選択時のため
        });

        clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            input.value = "";
            hidden.value = "";
            clearBtn.style.display = "none";
            suggest.style.display = "none";
        });

        // outsideクリックで閉じる
        document.addEventListener('mousedown', function(e) {
            if (!input.contains(e.target) && !suggest.contains(e.target) && e.target !== clearBtn) {
                suggest.style.display = "none";
            }
        });

        // --- 元々のスクリプト（持ち出し/譲渡/日付等） ---
        document.getElementById('start_date').value = getToday();
        document.getElementById('end_date').value = getThreeMonthLast();
        document.getElementById('transfer_date').value = getToday();

        // 要素取得
        const cb_checkout = document.getElementById('with_checkout_cb');
        const area_checkout = document.getElementById('checkout-area');
        const area_transfer = document.getElementById('with_transfer_area');
        const cb_transfer = document.getElementById('with_transfer_cb');
        const transferDetailArea = document.getElementById('transfer-detail-area');
        const ownerTablesArea = document.getElementById('owner-tables-area');

        function toggleCheckoutArea() {
            // 持ち出し申請欄表示
            area_checkout.style.display = cb_checkout.checked ? "block" : "none";
            // 譲渡申請親欄表示
            area_transfer.style.display = cb_checkout.checked ? "block" : "none";
            // 所有者テーブル生成・消去
            if (cb_checkout.checked) {
                if (typeof createOwnerTables === 'function') createOwnerTables();
            } else {
                ownerTablesArea.innerHTML = '';
            }
            // 持ち出しOFFのとき譲渡関連もOFF
            if (!cb_checkout.checked) {
                cb_transfer.checked = false;
                transferDetailArea.style.display = "none";
            }
        }
        function toggleTransferDetail() {
            transferDetailArea.style.display = cb_transfer.checked ? "block" : "none";
            if (cb_transfer.checked) {
                createTransferBranchTables();
            } else {
                document.getElementById('transfer-branch-tables').innerHTML = '';
            }
        }

        // イベントセット
        cb_checkout.addEventListener('change', toggleCheckoutArea);
        cb_transfer.addEventListener('change', toggleTransferDetail);

        // 初期化
        toggleCheckoutArea();
        toggleTransferDetail();
    });

    // 日付セット
    function getToday() {
        const d = new Date();
        return d.toISOString().slice(0, 10);
    }
    function getThreeMonthLast() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const after3 = new Date(y, m + 3, 1);
        const lastDay = new Date(after3.getFullYear(), after3.getMonth(), 0);
        // 日本のローカル表記にする
        return lastDay.toLocaleDateString('ja-JP', {year: 'numeric', month: '2-digit', day: '2-digit'})
                    .replace(/\//g, '-');
    }

    // 申請時チェック
    function checkAndSubmit() {
        var allChecked = true;
        var checks = document.querySelectorAll('input[name="qty_checked"]:not(:checked)');
        if (checks.length > 0) {
            alert("全ての数量チェックにチェックしてください");
            return false;
        }
        // 管理者未選択チェック
        var manager = document.getElementById('manager').value;
        if (!manager) {
            alert("管理者の入力が不正です。正しい管理者を選択してください");
            document.getElementById('manager_input').focus();
            return false;
        }
        // 持ち出し＋譲渡同時申請時のバリデーション
        var cb_checkout = document.getElementById('with_checkout_cb');
        var cb_transfer = document.getElementById('with_transfer_cb');
        if (cb_checkout.checked && cb_transfer.checked) {
            var checkedBranches = document.querySelectorAll('input[name="transfer_branch_ids"]:checked');
            if (checkedBranches.length == 0) {
                alert("譲渡する枝番を1つ以上選択してください");
                return false;
            }
            var transferComment = document.getElementById('transfer_comment').value.trim();
            if (!transferComment) {
                alert("譲渡コメントを入力してください");
                return false;
            }
        }
        return true;
    }

    // 所有者テーブル生成（持ち出し申請ON時のみ呼ばれる）
    function createOwnerTables() {
        let checked = document.getElementById('with_checkout_cb').checked;
        let area = document.getElementById('owner-tables-area');
        area.innerHTML = '';
        if (!checked) {
            area.style.display = "none";
            return;
        }
        let items = [];
        {% for item in items %}
            items.push({
                id: "{{ item['id'] }}",
                num_of_samples: parseInt("{{ item['num_of_samples']|default(1) }}"),
                product_name: "{{ item['product_name']|default('')|e }}"
            });
        {% endfor %}
        let username = "{{ g.user['username'] }}";
        let allHtml = `<b>所有者</b>`;
        for (let it of items) {
            let t = `<div style="margin-top:12px; margin-bottom:20px;"><b>ID ${it.id}（${it.product_name}）</b><br>
                <table style="border-collapse:collapse;">
                <tr>
                    <th style="border:1px solid #aaa;padding:5px 10px;">枝番</th>
                    <th style="border:1px solid #aaa;padding:5px 10px;">所有者</th>
                </tr>`;
            let n = it.num_of_samples;
            if (!n || n<=0) n = 1;
            for (let i=1; i<=n; i++) {
                t += `<tr>
                <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">${i}</td>
                <td style="border:1px solid #aaa;padding:5px 10px;" contenteditable="true">
                    <input type="hidden" name="owner_list_${it.id}" value="${username}">
                    ${username}
                </td>
                </tr>`;
            }
            t += `</table></div>`;
            allHtml += t;
        }
        area.innerHTML = allHtml;
        area.style.display = "block";
        // 編集内容をhidden inputに反映
        let tds = area.querySelectorAll('td[contenteditable="true"]');
        tds.forEach(td => {
            td.addEventListener('input', function() {
                let input = td.querySelector('input[type="hidden"]');
                input.value = td.innerText.trim();
            });
        });
    }

    // 譲渡対象枝番テーブル生成（持ち出し＋譲渡申請ON時のみ呼ばれる）
    function createTransferBranchTables() {
        let area = document.getElementById('transfer-branch-tables');
        area.innerHTML = '';
        let items = [];
        {% for item in items %}
            items.push({
                id: "{{ item['id'] }}",
                num_of_samples: parseInt("{{ item['num_of_samples']|default(1) }}"),
                product_name: "{{ item['product_name']|default('')|e }}"
            });
        {% endfor %}

        // 各アイテムごとに枝番選択テーブルを出す
        let allHtml = "";
        for (let it of items) {
            let t = `<div style="margin-bottom:18px;"><b>ID ${it.id}（${it.product_name}） 譲渡する枝番を選択</b>
                <table style="border-collapse:collapse;">
                <tr>
                    <th style="border:1px solid #aaa;padding:5px 10px;">選択</th>
                    <th style="border:1px solid #aaa;padding:5px 10px;">枝番</th>
                </tr>`;
            let n = it.num_of_samples;
            if (!n || n <= 0) n = 1;
            for (let i = 1; i <= n; i++) {
                t += `<tr>
                <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">
                    <input type="checkbox" name="transfer_branch_ids" value="${it.id}_${i}">
                </td>
                <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">${i}</td>
                </tr>`;
            }
            t += `</table></div>`;
            allHtml += t;
        }
        area.innerHTML = allHtml;
    }
</script>
{% endblock %}
