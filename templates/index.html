<!DOCTYPE html>
<html>
<head>
    <title>Item List</title>
    <style>
        table { border-collapse: collapse; width: 98%; }
        th, td { border: 1px solid #aaa; padding: 5px; min-width: 90px; font-size: 14px; }
        th { background: #eee; }
        td.editing, td.filter-editing { background: #d0e3f7; }
        .filter-row td, .filter-row th {
            background: #f5f5cc !important;
            font-style: italic;
        }
        .filter-indicator {
            color: #33691e;
            font-weight: bold;
            margin-left: 10px;
            font-size: 14px;
            background: #f5f5cc;
            border-radius: 4px;
            padding: 2px 8px;
        }
        .button-group { margin-top: 10px; }
        .button-group button, .button-group a {
            margin-right: 8px; padding: 6px 16px; border-radius: 4px;
            border: none; background: #4285f4; color: #fff; text-decoration: none; cursor: pointer;
        }
        .button-group button.delete { background: #db4437; }
        .pagination a, .pagination strong {
            margin: 0 3px; padding: 3px 9px; border-radius: 4px;
            background: #eee; text-decoration: none; color: #333;
        }
        .pagination strong { background: #4285f4; color: #fff; }
        .summary { font-size: 14px; color: #555; margin-bottom: 8px; }
        .filter-cell input[type="text"] {
            width: 90%; padding:2px 4px; font-size:13px;
            border: 1px solid #bbb; background: #fffde7; outline: none;
        }
        .filter-toggle {
            background: #ffd600; color: #333;
            border: none; border-radius: 4px; padding: 5px 14px;
            margin-bottom: 6px; font-size: 14px; cursor: pointer;
        }
        .filter-toggle.on { background: #ffee58; }
    </style>
    <script>
        // Excel風編集
        document.addEventListener('DOMContentLoaded', function () {
            // データ編集
            document.querySelectorAll('td[data-editable="true"]').forEach(function(td) {
                td.addEventListener('click', function(e) {
                    if (td.classList.contains('editing')) return;
                    td.classList.add('editing');
                    let oldValue = td.innerText.trim();
                    td.contentEditable = true;
                    td.focus();

                    function finishEdit() {
                        td.classList.remove('editing');
                        td.contentEditable = false;
                        td.removeEventListener('blur', finishEdit);
                        td.removeEventListener('keydown', keyHandler);
                        // hidden inputの値を編集内容で上書き
                        let hidden = td.querySelector('input[type="hidden"]');
                        if (hidden) hidden.value = td.innerText.trim();
                    }
                    function keyHandler(e) {
                        if (e.key === 'Enter') { e.preventDefault(); td.blur(); }
                        else if (e.key === 'Escape') { td.innerText = oldValue; td.blur(); }
                    }
                    td.addEventListener('blur', finishEdit);
                    td.addEventListener('keydown', keyHandler);
                });
            });

            // フィルタトグル
            document.getElementById('toggle-filter').addEventListener('click', function () {
                var row = document.getElementById('filter-row');
                if (row.style.display === 'none') {
                    row.style.display = '';
                    this.classList.add('on');
                } else {
                    row.style.display = 'none';
                    this.classList.remove('on');
                }
            });

            // フィルタ欄Excel風
            document.querySelectorAll('td[data-filter-editable="true"]').forEach(function(td) {
                let input = td.querySelector('input');
                td.addEventListener('click', function(e) {
                    input.focus();
                });
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('filter-form').submit();
                    }
                });
            });

            // 初期表示時にフィルタ値がなければフィルタ行を非表示
            var row = document.getElementById('filter-row');
            var hasFilter = {{ (filters.values()|join('')|length > 0)|tojson }};
            if (!hasFilter) {
                row.style.display = 'none';
                document.getElementById('toggle-filter').classList.remove('on');
            } else {
                document.getElementById('toggle-filter').classList.add('on');
            }
        });

        function toggleAll(source) {
            let checkboxes = document.getElementsByName('selected_ids');
            for (let i = 0; i < checkboxes.length; i++) checkboxes[i].checked = source.checked;
        }
        function submitDelete() {
            var form = document.getElementById('main-form');
            form.action = "{{ url_for('delete_selected') }}"; form.method = "POST"; form.submit();
        }
        // submitUpdateは不要。button type=submitで十分
    </script>
</head>
<body>
    <h1>Item List</h1>
    <div class="summary">
      全{{ total }}件
      {% if filters.values()|join('')|length > 0 %}
        <span class="filter-indicator">フィルタ中</span>
      {% endif %}
      <button type="button" class="filter-toggle" id="toggle-filter">フィルタを表示/非表示</button>
    </div>
    <!-- フィルタフォーム（GET） -->
    <form id="filter-form" method="get" action="{{ url_for('index') }}">
        <table>
            <tr>
                <th></th>
                <th>ID</th>
                {% for f in range(1, 11) %}
                <th>field{{f}}</th>
                {% endfor %}
            </tr>
            <tr id="filter-row" class="filter-row">
                <td class="filter-cell" colspan="2" style="text-align:right;color:#666;font-weight:bold;">フィルタ行</td>
                {% for f in range(1, 11) %}
                <td class="filter-cell" data-filter-editable="true">
                    <input
                        type="text" name="field{{f}}_filter"
                        value="{{ filters['field'+f|string] }}"
                        placeholder="filter"
                    >
                </td>
                {% endfor %}
            </tr>
        </table>
    </form>

    <!-- データ編集用フォーム（POST、一括保存・削除用） -->
    <form id="main-form" method="post" action="{{ url_for('update_items', page=page, **filters) }}">
        <table>
            {% for item in items %}
            <tr>
                <td>
                    <input type="checkbox" name="selected_ids" value="{{ item['id'] }}">
                    <input type="hidden" name="item_id" value="{{ item['id'] }}">
                </td>
                <td>{{ item['id'] }}</td>
                {% for f in range(1, 11) %}
                <td data-editable="true">
                    {{ item['field' ~ f] }}
                    <input type="hidden" name="field{{f}}_{{item['id']}}" value="{{ item['field' ~ f] }}">
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
        <div class="button-group">
            <button type="button" class="delete" onclick="submitDelete()">選択したアイテムを削除</button>
            <button type="submit">編集内容を一括保存</button>
            <a href="{{ url_for('add') }}">追加</a>
        </div>
    </form>
    <div class="pagination">
      {% for p in range(1, page_count+1) %}
        {% if p == page %}
          <strong>{{p}}</strong>
        {% else %}
          <a href="{{ url_for('index', page=p, **filters) }}">{{p}}</a>
        {% endif %}
      {% endfor %}
    </div>
</body>
</html>
