{% extends "_base.html" %}

{% block title %}持ち出し申請{% endblock %}

{% block head %}
<style>
    table { border-collapse: collapse; }
    th, td { border: 1px solid #aaa; padding: 5px 10px; }
    th { background: #eee; }
    .button-group { margin-top: 18px; }
    .main-btn {
        background: #4285f4;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        font-weight: bold;
        padding: 6px 16px;
        margin-right: 8px;
        cursor: pointer;
        text-decoration: none;
        transition: background .15s;
    }
    .main-btn:hover { background: #23468e; color: #fff; }
    .form-field { margin-bottom: 12px; }
    .form-label { display: block; font-weight: bold; margin-bottom: 4px; }
    .form-input, .form-textarea, .form-select { width: 320px; font-size: 1rem; padding: 5px; border-radius: 4px; border: 1px solid #bbb; }
    .form-textarea { height: 56px; resize: vertical; }
    .info-message { color: #33691e; font-weight: bold; margin: 8px 0; }

    .form-input[type="date"] {
        width: 140px;
        min-width: 100px;
        max-width: 180px;
    }
    .input-clear-wrap {
        position: relative;
        display: inline-block;
        width: 320px;
        vertical-align: middle;
    }
    .form-input {
        width: 100%;
        box-sizing: border-box;
    }
    .clear-btn {
        position: absolute;
        right: 6px;
        top: 55%;
        transform: translateY(-40%);
        cursor: pointer;
        font-size: 1.03em;
        color: #bbb;
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        line-height: 1;
        display: none;
        z-index: 10;
        width: 1.3em;
        height: 1.3em;
        text-align: center;
        transition: color 0.13s;
        user-select: none;
    }
    .clear-btn:hover { color: #888; background: none; }
    .suggest-list {
        position: absolute; background: #fff; border: 1px solid #bbb; border-radius: 6px;
        box-shadow: 0 2px 8px #bbb8; z-index: 100; min-width: 320px; max-height: 180px; overflow-y: auto;
        display: none;
    }
    .suggest-item {
        padding: 6px 16px; cursor: pointer;
    }
    .suggest-item:hover, .suggest-item.active { background: #e3f2fd; }
    .relative { position: relative; }
    /* 所有者ウィジェット */
    .owner-cell .input-clear-wrap { width: 280px; }
    .owner-cell .form-input { padding-right: 1.8em; } /* ×の余白 */
    .owner-cell .clear-btn { top: 50%; transform: translateY(-50%); }
    .owner-suggest.suggest-list { min-width: 280px; }

    /* 不正表示 */
    .owner-visible.invalid {
        border-color: #e53935;
        background: #ffebee;
    }
</style>
{% endblock %}

{% block content %}
<h1>持ち出し申請</h1>
<form method="get" onsubmit="return checkAndSubmit();">
    {% if request.args.get('from_menu') %}
        <input type="hidden" name="from_menu" value="1">
    {% endif %}
    <input type="hidden" name="action" value="submit">
    <table>
        <tr>
            <th>ID</th>
            {% for f in fields %}
            <th>{{ f.name }}</th>
            {% endfor %}
            <th>サンプル数</th>
            <th>数量チェック</th>
        </tr>
        {% for item in items %}
        <tr>
            <td>
                {{ item['id'] }}
                <input type="hidden" name="item_id" value="{{ item['id'] }}">
            </td>
            {% for f in fields %}
            <td>{{ item[f.key] }}</td>
            {% endfor %}
            <td>{{ item['available_count'] }}</td>
            <td><input type="checkbox" name="qty_checked"></td>
        </tr>
        {% endfor %}
    </table>
    <div style="margin-top: 24px; margin-bottom: 8px;">
        <!-- 管理者欄：properユーザーサジェスト＋クリア -->
        <div class="form-field relative">
            <label class="form-label" for="manager_input">管理者</label>
            <div class="input-clear-wrap">
                <input class="form-input" type="text" id="manager_input" autocomplete="off" value="" placeholder="管理者を入力">
                <span id="manager_clear" class="clear-btn" title="クリア">&#10005;</span>
            </div>
            <input type="hidden" id="manager" name="manager" value="">
            <div id="manager_suggest" class="suggest-list"></div>
        </div>
        <div id="checkout-area">
            <div class="form-field">
                <label class="form-label" for="start_date">持ち出し開始日</label>
                <input class="form-input" type="date" id="start_date" name="start_date">
            </div>
            <div class="form-field">
                <label class="form-label" for="end_date">持ち出し終了日</label>
                <input class="form-input" type="date" id="end_date" name="end_date">
            </div>
            <div id="owner-tables-area" style="margin-top:25px;"></div>
        </div>
        <div id="with_transfer_area" style="margin-top:8px;">
            <label class="form-label">
                <input type="checkbox" name="with_transfer" value="1" id="with_transfer_cb">
                譲渡申請も同時に行う
            </label>
            <div id="transfer-detail-area" style="display:none; margin-top:8px;">
                <div class="form-field">
                    <label class="form-label" for="transfer_date">譲渡日</label>
                    <input class="form-input" type="date" id="transfer_date" name="transfer_date">
                </div>
                <div id="transfer-branch-tables"></div>
                <div class="form-field">
                    <label class="form-label" for="transfer_comment">譲渡コメント</label>
                    <textarea class="form-textarea" id="transfer_comment" name="transfer_comment"></textarea>
                </div>
            </div>
        </div>
        <div class="form-field">
            <label class="form-label" for="comment">申請コメント</label>
            <textarea class="form-textarea" id="comment" name="comment"></textarea>
        </div>
        <!-- 承認者：ドロップダウン -->
        <div class="form-field">
            <label class="form-label" for="approver">承認者</label>
            <select class="form-select" id="approver" name="approver" required>
                {% for m in approver_list %}
                    <option value="{{ m.username }}"
                        {% if m.username == approver_default %}selected{% endif %}>
                        {{ m.department }} {{ m.realname }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="button-group">
        <button type="submit" class="main-btn">申請</button>
        <a href="{% if request.args.get('from_menu') or request.form.get('from_menu') %}{{ url_for('menu') }}{% else %}{{ url_for('index') }}{% endif %}" class="main-btn" style="background:#aaa;">キャンセル</a>
    </div>
</form>
{% if finish %}
<h2>申請内容</h2>
<table>
    <tr>
        <th>ID</th>
        {% for f in fields %}
        <th>{{ f.name }}</th>
        {% endfor %}
    </tr>
    {% for item in items %}
    <tr>
        <td>{{ item['id'] }}</td>
        {% for f in fields %}
        <td>{{ item[f.key] }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>
<div class="button-group" style="margin-top: 20px;">
    <a href="{{ url_for('index') }}" class="main-btn" style="background:#4285f4;">一覧に戻る</a>
</div>
{% endif %}
<script>
    // properユーザーサジェスト
    const properUsers = {{ proper_users|tojson|safe }};
    const myUsername = "{{ manager_default|e }}";
    const myUser = properUsers.find(u => u.username === myUsername);

    // ▼ 追加: 所有者候補（proper+partner）
    const ownerCandidates = {{ owner_candidates|tojson|safe }};
    const loginOwnerUser = ownerCandidates.find(u => u.username === "{{ g.user['username'] }}");

    function formatUser(user) {
        return (user.department ? user.department + " " : "") + user.realname;
    }

    function showSuggestList(users) {
        const suggest = document.getElementById('manager_suggest');
        suggest.innerHTML = "";
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = "suggest-item";
            div.textContent = formatUser(user);
            div.dataset.username = user.username;
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                document.getElementById('manager_input').value = formatUser(user);
                document.getElementById('manager').value = user.username;
                suggest.style.display = "none";
                document.getElementById('manager_clear').style.display = "inline";
            });
            suggest.appendChild(div);
        });
        suggest.style.display = users.length > 0 ? "block" : "none";
    }

    document.addEventListener("DOMContentLoaded", function() {
        // 管理者欄サジェスト初期化
        const input = document.getElementById('manager_input');
        const hidden = document.getElementById('manager');
        const suggest = document.getElementById('manager_suggest');
        const clearBtn = document.getElementById('manager_clear');
        if (myUser) {
            input.value = formatUser(myUser);
            hidden.value = myUser.username;
            clearBtn.style.display = "inline";
        } else {
            input.value = "";
            hidden.value = "";
            clearBtn.style.display = "none";
        }
        input.addEventListener('focus', function() { showSuggestList(properUsers); });
        input.addEventListener('input', function(e) {
            const val = input.value;
            if (val.length === 0) {
                input.value = "";
                hidden.value = "";
                suggest.style.display = "none";
                clearBtn.style.display = "none";
                return;
            }
            const filtered = properUsers.filter(u =>
                (u.realname && u.realname.indexOf(val) !== -1) ||
                (u.department && u.department.indexOf(val) !== -1)
            );
            showSuggestList(filtered);
            hidden.value = "";
            clearBtn.style.display = "inline";
        });
        input.addEventListener('focus', function() {
            if (input.value.length > 0) clearBtn.style.display = "inline";
        });
        input.addEventListener('blur', function() {
            setTimeout(function() { suggest.style.display = "none"; }, 150);
        });
        clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            input.value = "";
            hidden.value = "";
            clearBtn.style.display = "none";
            suggest.style.display = "none";
        });
        document.addEventListener('mousedown', function(e) {
            if (!input.contains(e.target) && !suggest.contains(e.target) && e.target !== clearBtn) {
                suggest.style.display = "none";
            }
        });

        // サーババリデーションエラーをalertで
        {% if error_dialog_message %}
            alert({{ error_dialog_message|tojson }});
        {% endif %}

        // ---- 日付セット ----
        document.getElementById('start_date').value = getToday();
        document.getElementById('end_date').value = getThreeMonthLast();
        document.getElementById('transfer_date').value = getToday();

        // 所有者テーブル生成
        if (typeof createOwnerTables === 'function') createOwnerTables();

        // 譲渡切替
        const cb_transfer = document.getElementById('with_transfer_cb');
        const transferDetailArea = document.getElementById('transfer-detail-area');
        cb_transfer.addEventListener('change', function() {
            transferDetailArea.style.display = cb_transfer.checked ? "block" : "none";
            if (cb_transfer.checked) createTransferBranchTables();
            else document.getElementById('transfer-branch-tables').innerHTML = '';
        });
    });

    function getToday() {
        const d = new Date();
        return d.toISOString().slice(0, 10);
    }
    function getThreeMonthLast() {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth();
        const after3 = new Date(y, m + 3, 1);
        const lastDay = new Date(after3.getFullYear(), after3.getMonth(), 0);
        return lastDay.toLocaleDateString('ja-JP', {year: 'numeric', month: '2-digit', day: '2-digit'}).replace(/\//g, '-');
    }

    function checkAndSubmit() {
        var checks = document.querySelectorAll('input[name="qty_checked"]:not(:checked)');
        if (checks.length > 0) {
            alert("全ての数量チェックにチェックしてください");
            return false;
        }
        var manager = document.getElementById('manager').value;
        if (!manager) {
            alert("管理者を選択してください");
            document.getElementById('manager_input').focus();
            return false;
        }

        // ▼ 所有者チェック
        const ownerHiddens = document.querySelectorAll('input[name^="owner_list_"]');
        if (ownerHiddens.length === 0) {
            alert("所有者入力欄生成に失敗しました。ページを更新してください。");
            return false;
        }
        let firstInvalid = null;
        ownerHiddens.forEach(h => {
            const cell = h.closest('.owner-cell');
            const vis = cell ? cell.querySelector('.owner-visible') : null;
            if (!h.value) {
                if (vis) vis.classList.add('invalid');
                if (!firstInvalid) firstInvalid = vis || h;
            }
        });
        if (firstInvalid) {
            alert("所有者の入力が不正です。候補から選択してください。");
            if (firstInvalid.focus) firstInvalid.focus();
            return false;
        }

        var cb_transfer = document.getElementById('with_transfer_cb');
        if (cb_transfer.checked) {
            var checkedBranches = document.querySelectorAll('input[name="transfer_branch_ids"]:checked');
            if (checkedBranches.length == 0) {
                alert("譲渡する枝番を1つ以上選択してください");
                return false;
            }
            var transferComment = document.getElementById('transfer_comment').value.trim();
            if (!transferComment) {
                alert("譲渡コメントを入力してください");
                return false;
            }
        }
        return true;
    }

    // ▼ 所有者サジェスト共通関数
    function renderOwnerSuggest(container, users, onPick) {
        container.innerHTML = "";
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = "suggest-item";
            div.textContent = formatUser(user);
            div.dataset.username = user.username;
            div.addEventListener('mousedown', function(e) {
                e.preventDefault();
                onPick(user);
            });
            container.appendChild(div);
        });
        container.style.display = users.length > 0 ? "block" : "none";
    }
    function filterOwner(query) {
        const q = (query || "").trim();
        if (!q) return ownerCandidates;
        return ownerCandidates.filter(u =>
            (u.realname && u.realname.indexOf(q) !== -1) ||
            (u.department && u.department.indexOf(q) !== -1) ||
            (u.username && u.username.indexOf(q) !== -1)
        );
    }
    function resolveOwnerInput(input, hidden) {
        const val = (input.value || "").trim();
        if (!val) { hidden.value = ""; return false; }
        let hit = ownerCandidates.find(u => u.username === val) ||
                  ownerCandidates.find(u => (u.department ? u.department + " " + u.realname : u.realname) === val);
        if (hit) {
            input.value = (hit.department ? hit.department + " " : "") + hit.realname;
            hidden.value = hit.username;
            input.classList.remove('invalid');
            return true;
        } else {
            hidden.value = "";
            return false;
        }
    }
    function wireOwnerInput({inputEl, hiddenEl, clearEl, suggestEl}) {
        function pickUser(user) {
            inputEl.value = (user.department ? user.department + " " : "") + user.realname;
            hiddenEl.value = user.username;
            suggestEl.style.display = "none";
            clearEl.style.display = "inline";
            inputEl.classList.remove('invalid');
        }
        resolveOwnerInput(inputEl, hiddenEl);
        inputEl.addEventListener('focus', () => {
            renderOwnerSuggest(suggestEl, ownerCandidates, pickUser);
            if (inputEl.value) clearEl.style.display = "inline";
        });
        inputEl.addEventListener('input', () => {
            const val = inputEl.value.trim();
            hiddenEl.value = "";
            inputEl.classList.remove('invalid');
            if (!val) {
                suggestEl.style.display = "none";
                clearEl.style.display = "none";
                return;
            }
            renderOwnerSuggest(suggestEl, filterOwner(val), pickUser);
            clearEl.style.display = "inline";
        });
        inputEl.addEventListener('paste', () => setTimeout(() => resolveOwnerInput(inputEl, hiddenEl), 0));
        inputEl.addEventListener('change', () => resolveOwnerInput(inputEl, hiddenEl));
        inputEl.addEventListener('blur', () => {
            setTimeout(()=>{ suggestEl.style.display="none"; }, 150);
            const txt = (inputEl.value || "").trim();
            if (txt && !hiddenEl.value) inputEl.classList.add('invalid');
        });
        clearEl.addEventListener('click', (e) => {
            e.preventDefault();
            inputEl.value = "";
            hiddenEl.value = "";
            clearEl.style.display = "none";
            suggestEl.style.display = "none";
            inputEl.classList.remove('invalid');
            inputEl.focus();
        });
    }

    function createOwnerTables() {
        const area = document.getElementById('owner-tables-area');
        area.innerHTML = '';
        const items = [];
        {% for item in items %}
            items.push({
                id: "{{ item['id'] }}",
                product_name: "{{ item['product_name']|default('')|e }}",
                branches: {{ item['available_branches']|tojson|safe }}
            });
        {% endfor %}
        const defUser = loginOwnerUser || null;
        let htmlAll = `<b>所有者</b>`;
        for (const it of items) {
            let t = `<div style="margin-top:12px; margin-bottom:20px;"><b>ID ${it.id}（${it.product_name}）</b><br>
                <table style="border-collapse:collapse;">
                <tr>
                    <th style="border:1px solid #aaa;padding:5px 10px;">枝番</th>
                    <th style="border:1px solid #aaa;padding:5px 10px;">所有者</th>
                </tr>`;
            for (const b of it.branches) {
                const inputId = `owner_input_${it.id}_${b}`;
                const hiddenId = `owner_hidden_${it.id}_${b}`;
                const clearId  = `owner_clear_${it.id}_${b}`;
                const suggestId= `owner_suggest_${it.id}_${b}`;
                const disp = defUser ? formatUser(defUser) : "";
                const hid  = defUser ? defUser.username : "";
                t += `<tr>
                    <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">${b}</td>
                    <td class="owner-cell" style="border:1px solid #aaa;padding:5px 10px;position:relative;">
                        <div class="input-clear-wrap">
                            <input type="text" class="form-input owner-visible"
                                   id="${inputId}" autocomplete="off" placeholder="部署名 氏名" value="${disp}">
                            <span id="${clearId}" class="clear-btn owner-clear" title="クリア" style="${disp ? 'display:inline' : 'display:none'}">&#10005;</span>
                        </div>
                        <input type="hidden" name="owner_list_${it.id}" id="${hiddenId}" value="${hid}">
                        <div id="${suggestId}" class="suggest-list owner-suggest"></div>
                    </td>
                </tr>`;
            }
            t += `</table></div>`;
            htmlAll += t;
        }
        area.innerHTML = htmlAll;
        area.style.display = "block";
        for (const it of items) {
            for (const b of it.branches) {
                wireOwnerInput({
                    inputEl:   document.getElementById(`owner_input_${it.id}_${b}`),
                    hiddenEl:  document.getElementById(`owner_hidden_${it.id}_${b}`),
                    clearEl:   document.getElementById(`owner_clear_${it.id}_${b}`),
                    suggestEl: document.getElementById(`owner_suggest_${it.id}_${b}`),
                });
            }
        }
    }

    function createTransferBranchTables() {
        let area = document.getElementById('transfer-branch-tables');
        area.innerHTML = '';
        let items = [];
        {% for item in items %}
            items.push({
                id: "{{ item['id'] }}",
                product_name: "{{ item['product_name']|default('')|e }}",
                branches: {{ item['available_branches']|tojson|safe }}
            });
        {% endfor %}
        let allHtml = "";
        for (let it of items) {
            let t = `<div style="margin-bottom:18px;"><b>ID ${it.id}（${it.product_name}） 譲渡する枝番を選択</b>
                <table style="border-collapse:collapse;">
                <tr>
                    <th style="border:1px solid #aaa;padding:5px 10px;">選択</th>
                    <th style="border:1px solid #aaa;padding:5px 10px;">枝番</th>
                </tr>`;
            for (let b of it.branches) {
                t += `<tr>
                    <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">
                        <input type="checkbox" name="transfer_branch_ids" value="${it.id}_${b}">
                    </td>
                    <td style="border:1px solid #aaa;padding:5px 10px;text-align:center;">${b}</td>
                </tr>`;
            }
            t += `</table></div>`;
            allHtml += t;
        }
        area.innerHTML = allHtml;
    }
</script>
{% endblock %}
