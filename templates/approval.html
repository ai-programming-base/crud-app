<!DOCTYPE html>
<html>
<head>
    <title>入庫申請 承認画面</title>
    <style>
        table { border-collapse: collapse; }
        th, td { border: 1px solid #aaa; padding: 5px 10px; }
        th { background: #eee; }
        .button-group { margin-top: 12px; }
        .button-group button, .button-group a { margin-right: 8px; padding: 6px 16px; border-radius: 4px; border: none; background: #4285f4; color: #fff; text-decoration: none; cursor: pointer; }
        .button-group button.approve { background: #43a047; }
        .button-group button.reject { background: #db4437; }
        .button-group a.cancel { background: #aaa; }
        .error-message { color: #db4437; font-weight: bold; margin: 8px 0; }
        .info-message { color: #33691e; font-weight: bold; margin: 8px 0; }
        .comment-box { width: 98%; padding: 6px; margin-top: 10px; font-size: 15px; border-radius: 4px; border: 1px solid #aaa; }
    </style>
    <script>
        function onApprove() {
            // チェックされている数
            var checked = document.querySelectorAll('input[name="selected_ids"]:checked').length;
            if (checked === 0) {
                alert("承認対象のアイテムを1件以上選択してください");
                return false;
            }
            if (!confirm("承認処理を行います。本来は申請者にメール通知します。")) return false;
            alert("承認完了！メール送信（ダイアログのみ）");
            return true;
        }
        function onReject() {
            var checked = document.querySelectorAll('input[name="selected_ids"]:checked').length;
            if (checked === 0) {
                alert("差し戻し対象のアイテムを1件以上選択してください");
                return false;
            }
            let comment = document.getElementById('reject_comment').value.trim();
            if (!comment) {
                alert("差し戻しコメントを入力してください");
                return false;
            }
            if (!confirm("差し戻し処理を行います。本来は申請者にメール通知します。")) return false;
            alert("差し戻し完了！メール送信（ダイアログのみ）\nコメント：" + comment);
            return true;
        }
    </script>
</head>
<body>
    <h1>入庫申請 承認画面</h1>
    {% if message %}
      <div class="info-message">{{ message }}</div>
    {% endif %}
    {% if not finish %}
    <form method="post">
        <table>
            <tr>
                <th><input type="checkbox" onclick="for(let c of document.getElementsByName('selected_ids')) c.checked=this.checked;"></th>
                <th>ID</th>
                {% for f in fields %}
                <th>{{ f.name }}</th>
                {% endfor %}
            </tr>
            {% for item in items %}
            <tr>
                <td>
                    <input type="checkbox" name="selected_ids" value="{{ item['id'] }}">
                </td>
                <td>{{ item['id'] }}</td>
                {% for f in fields %}
                <td>{{ item[f.key] }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
        <div style="margin-top:15px;">
            <label for="reject_comment"><b>差し戻しコメント:</b></label><br>
            <textarea id="reject_comment" name="reject_comment" class="comment-box" rows="3" placeholder="差し戻し理由・コメントを入力"></textarea>
        </div>
        <div class="button-group">
            <button type="submit" name="action" value="approve" class="approve" onclick="return onApprove();">承認</button>
            <button type="submit" name="action" value="reject" class="reject" onclick="return onReject();">差し戻し</button>
            <a href="{{ url_for('index') }}" class="cancel">キャンセル</a>
        </div>
    </form>
    {% endif %}
    <div>
      <a href="{{ url_for('index') }}">一覧に戻る</a>
    </div>
</body>
</html>
